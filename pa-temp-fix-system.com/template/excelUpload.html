<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel文件上传和数据展示</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.prod.js"></script>
    <script src="https://cdn.staticfile.org/axios/0.18.0/axios.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px 0;
        }
        .upload-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            background-color: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-area:hover {
            background-color: #e3f2fd;
            border-color: #0056b3;
        }
        .upload-area.dragover {
            background-color: #e3f2fd;
            border-color: #28a745;
        }
        .file-info {
            background-color: #e9f7ef;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .data-table {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .table-header {
            background-color: #007bff;
            color: white;
            padding: 15px 20px;
            font-weight: bold;
        }
        .preview-table th {
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .preview-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success {
            background-color: #28a745;
        }
        .status-error {
            background-color: #dc3545;
        }
        .status-processing {
            background-color: #ffc107;
        }
        .upload-progress {
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            background-color: #e9ecef;
        }
        .progress-bar-custom {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
        }
        .file-item {
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin-bottom: 10px;
            background-color: #fff;
        }
        .file-item.success {
            border-color: #28a745;
            background-color: #f8fff9;
        }
        .file-item.error {
            border-color: #dc3545;
            background-color: #fff5f5;
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <!-- 页面标题 -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <h1 class="display-6">
                    <i class="bi bi-file-earmark-excel text-success"></i>
                    Excel文件上传与数据处理
                </h1>
                <p class="text-muted">支持xlsx和xls格式文件，自动解析数据并展示预览</p>
            </div>
        </div>

        <!-- 上传区域 -->
        <div class="upload-card">
            <div class="table-header">
                <i class="bi bi-cloud-upload"></i> 文件上传
            </div>
            <div class="card-body">
                <!-- 上传配置 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="hasHeader" v-model="uploadConfig.hasHeader">
                            <label class="form-check-label" for="hasHeader">
                                第一行为表头
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">预览行数</span>
                            <select class="form-select" v-model="uploadConfig.previewRows">
                                <option value="5">5行</option>
                                <option value="10">10行</option>
                                <option value="20">20行</option>
                                <option value="50">50行</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 拖拽上传区域 -->
                <div class="upload-area" 
                     @drop.prevent="handleDrop"
                     @dragover.prevent="handleDragOver"
                     @dragleave.prevent="handleDragLeave"
                     @click="triggerFileInput">
                    <i class="bi bi-cloud-arrow-up" style="font-size: 3rem; color: #007bff;"></i>
                    <h4 class="mt-3">拖拽文件到此处或点击选择</h4>
                    <p class="text-muted">支持 .xlsx 和 .xls 格式，最大10MB</p>
                    <input type="file" 
                           ref="fileInput" 
                           @change="handleFileSelect" 
                           accept=".xlsx,.xls" 
                           multiple
                           style="display: none;">
                </div>

                <!-- 上传进度 -->
                <div v-if="uploadProgress.show" class="mt-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>上传进度</span>
                        <span>{{ uploadProgress.percentage }}%</span>
                    </div>
                    <div class="upload-progress">
                        <div class="progress-bar-custom" :style="{ width: uploadProgress.percentage + '%' }"></div>
                    </div>
                </div>

                <!-- 文件列表 -->
                <div v-if="uploadedFiles.length > 0" class="mt-4">
                    <h5>已上传文件</h5>
                    <div class="file-item" v-for="(file, index) in uploadedFiles" :key="index" :class="file.status">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi" :class="getFileIcon(file.extension)"></i>
                                <strong>{{ file.originalName }}</strong>
                                <span class="badge bg-secondary ms-2">{{ formatFileSize(file.size) }}</span>
                            </div>
                            <div>
                                <span class="status-indicator" :class="'status-' + file.status"></span>
                                <span class="text-muted small">{{ file.message }}</span>
                                <button v-if="file.status === 'success'" 
                                        @click="showFileData(index)" 
                                        class="btn btn-sm btn-outline-primary ms-2">
                                    <i class="bi bi-eye"></i> 查看数据
                                </button>
                                <button @click="removeFile(index)" class="btn btn-sm btn-outline-danger ms-2">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 数据预览区域 -->
        <div v-if="currentFileData" class="upload-card">
            <div class="table-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-table"></i> 数据预览 - {{ currentFileData.fileName }}
                </div>
                <div>
                    <span class="badge bg-light text-dark me-2">
                        {{ currentFileData.rowCount }} 行 × {{ currentFileData.columnCount }} 列
                    </span>
                    <button @click="closePreview" class="btn btn-sm btn-light">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- 表头信息 -->
                <div class="mb-3">
                    <h6>表头字段:</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <span v-for="(header, index) in currentFileData.headers" 
                              :key="index" 
                              class="badge bg-primary">
                            {{ header }}
                        </span>
                    </div>
                </div>

                <!-- 数据表格 -->
                <div class="preview-container">
                    <table class="table table-striped table-hover preview-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th v-for="(header, index) in currentFileData.headers" :key="index">
                                    {{ header }}
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(row, rowIndex) in currentFileData.preview" :key="rowIndex">
                                <td>{{ rowIndex + 1 }}</td>
                                <td v-for="(cell, cellIndex) in row" :key="cellIndex">
                                    {{ cell || '-' }}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 完整数据操作 -->
                <div class="mt-3 text-center">
                    <button @click="showFullData" class="btn btn-primary">
                        <i class="bi bi-list"></i> 查看完整数据 ({{ currentFileData.rowCount }}行)
                    </button>
                    <button @click="exportData" class="btn btn-success ms-2">
                        <i class="bi bi-download"></i> 导出数据
                    </button>
                </div>
            </div>
        </div>

        <!-- 错误提示 -->
        <div v-if="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i> {{ errorMessage }}
            <button type="button" class="btn-close" @click="errorMessage = ''"></button>
        </div>

        <!-- 成功提示 -->
        <div v-if="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i> {{ successMessage }}
            <button type="button" class="btn-close" @click="successMessage = ''"></button>
        </div>
    </div>

    <script>
        // 调试信息
        console.log('Vue对象:', typeof Vue);
        console.log('createApp函数:', typeof Vue?.createApp);
        
        if (typeof Vue === 'undefined' || typeof Vue.createApp !== 'function') {
            document.body.innerHTML = '<div class="container mt-5"><div class="alert alert-danger">Vue.js 加载失败，请检查网络连接或刷新页面</div></div>';
        } else {
            const { createApp } = Vue;

            createApp({
            data() {
                return {
                    uploadConfig: {
                        hasHeader: true,
                        previewRows: 10
                    },
                    uploadedFiles: [],
                    currentFileData: null,
                    uploadProgress: {
                        show: false,
                        percentage: 0
                    },
                    errorMessage: '',
                    successMessage: '',
                    apiUrl: 'http://172.16.29.23:90/php/controller/excelUpload.php'
                }
            },

            methods: {
                // 触发文件选择
                triggerFileInput() {
                    this.$refs.fileInput.click();
                },

                // 处理文件选择
                handleFileSelect(event) {
                    const files = Array.from(event.target.files);
                    this.uploadFiles(files);
                },

                // 处理拖拽上传
                handleDrop(event) {
                    event.currentTarget.classList.remove('dragover');
                    const files = Array.from(event.dataTransfer.files);
                    this.uploadFiles(files);
                },

                handleDragOver(event) {
                    event.currentTarget.classList.add('dragover');
                },

                handleDragLeave(event) {
                    event.currentTarget.classList.remove('dragover');
                },

                // 上传文件
                async uploadFiles(files) {
                    if (files.length === 0) return;

                    this.uploadProgress.show = true;
                    this.uploadProgress.percentage = 0;

                    const formData = new FormData();
                    
                    // 添加文件
                    if (files.length === 1) {
                        formData.append('excelFile', files[0]);
                    } else {
                        files.forEach(file => {
                            formData.append('excelFiles[]', file);
                        });
                    }

                    // 添加配置参数
                    formData.append('hasHeader', this.uploadConfig.hasHeader);
                    formData.append('previewRows', this.uploadConfig.previewRows);

                    try {
                        const response = await axios.post(this.apiUrl, formData, {
                            headers: {
                                'Content-Type': 'multipart/form-data'
                            },
                            onUploadProgress: (progressEvent) => {
                                this.uploadProgress.percentage = Math.round(
                                    (progressEvent.loaded * 100) / progressEvent.total
                                );
                            }
                        });

                        this.uploadProgress.show = false;

                        if (response.data.success) {
                            if (Array.isArray(response.data.data)) {
                                // 多文件上传
                                response.data.data.forEach((fileResult, index) => {
                                    this.addUploadedFile(files[index], fileResult);
                                });
                            } else {
                                // 单文件上传
                                this.addUploadedFile(files[0], response.data);
                            }
                            this.successMessage = response.data.message;
                        } else {
                            this.errorMessage = response.data.message;
                        }

                    } catch (error) {
                        this.uploadProgress.show = false;
                        this.errorMessage = '上传失败: ' + (error.response?.data?.message || error.message);
                        console.error('上传错误:', error);
                    }
                },

                // 添加上传的文件到列表
                addUploadedFile(originalFile, result) {
                    const fileInfo = {
                        originalName: originalFile.name,
                        size: originalFile.size,
                        extension: originalFile.name.split('.').pop().toLowerCase(),
                        status: result.success ? 'success' : 'error',
                        message: result.message,
                        data: result.success ? result.data : null
                    };

                    this.uploadedFiles.push(fileInfo);
                },

                // 显示文件数据
                showFileData(index) {
                    const file = this.uploadedFiles[index];
                    if (file.status === 'success' && file.data) {
                        this.currentFileData = file.data;
                    }
                },

                // 关闭预览
                closePreview() {
                    this.currentFileData = null;
                },

                // 显示完整数据
                showFullData() {
                    // 这里可以实现完整数据的展示逻辑
                    alert('完整数据展示功能待实现');
                },

                // 导出数据
                exportData() {
                    // 这里可以实现数据导出功能
                    alert('数据导出功能待实现');
                },

                // 删除文件
                removeFile(index) {
                    this.uploadedFiles.splice(index, 1);
                    if (this.currentFileData && index === this.uploadedFiles.findIndex(f => f.data === this.currentFileData)) {
                        this.currentFileData = null;
                    }
                },

                // 获取文件图标
                getFileIcon(extension) {
                    const iconMap = {
                        'xlsx': 'bi-file-earmark-excel',
                        'xls': 'bi-file-earmark-excel'
                    };
                    return iconMap[extension] || 'bi-file-earmark';
                },

                // 格式化文件大小
                formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                }
            },

            mounted() {
                console.log('Excel上传页面已加载');
            }
        }).mount('#app');
        }
    </script>
</body>
</html>