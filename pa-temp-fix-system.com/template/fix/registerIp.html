<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>登记个人IP</title>
    <link href="../css_js/bootstrap-5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="../css_js/script/jquery-3.7.0.min.js"></script>
    <script src="../css_js/bootstrap-5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="../css_js/script/vue.global.js"></script>
    <script src="../css_js/script/axios.min.js"></script>
    <script src="../css_js/script/qs.min.js"></script>
    <!-- Toast通知脚本 -->
    <script src="../css_js/js/toast.js"></script>
    <link rel="stylesheet" href="../css_js/bootstrap-5.3.0/css/bootstrap-icons.min.css">
    <!-- 粒子特效 -->
    <link rel="stylesheet" href="../css_js/own/lizi.css">
    <!-- Toast通知样式 -->
    <link rel="stylesheet" href="../css_js/css/toast.css">
    <style>
        body {
            background-color: #f0f2f5;
            padding: 20px 0;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #0d6efd;
            color: white;
            font-weight: bold;
        }
        .form-control {
            border-radius: 6px;
        }
        .btn-action {
            width: 100%;
            padding: 8px 0;
            font-weight: bold;
        }
        .alert-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
        }
        .ip-info-card {
            background-color: #e7f3ff;
            border-left: 4px solid #0d6efd;
        }
        .visitor-stats {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .visit-record-card {
            background-color: #d1ecf1;
            border-left: 4px solid #17a2b8;
        }
        .auto-record-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background-color: #28a745;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
        }
        .auto-record-indicator.show {
            display: block;
            animation: fadeInOut 3s ease-in-out;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(-20px); }
            20%, 80% { opacity: 1; transform: translateY(0); }
        }
        .recent-visits {
            max-height: 300px;
            overflow-y: auto;
        }
        .visit-item {
            padding: 10px;
            margin-bottom: 8px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #0d6efd;
        }
        .visit-item.new {
            background-color: #d4edda;
            border-left-color: #28a745;
            animation: highlight 2s ease-in-out;
        }
        @keyframes highlight {
            0% { background-color: #d4edda; }
            100% { background-color: #f8f9fa; }
        }
    </style>
</head>
<body>
<!-- 自动记录提示 -->
<div id="autoRecordIndicator" class="auto-record-indicator">
    <i class="bi bi-check-circle"></i> 访问已自动记录
</div>

<div class="container" id="app">
    <!-- 页面标题和环境信息 -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h2>{{ message }}</h2>
            <p class="text-muted">当前环境：<span :class="envClass">{{ envMsg }}</span></p>
        </div>
    </div>



    <!-- 访问者IP信息卡片 -->
    <div class="card ip-info-card">
        <div class="card-header">
            <i class="bi bi-info-circle"></i> 您的访问信息
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>您的IP地址：</strong> <span class="text-primary">{{ visitorIp || '获取中...' }}</span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>访问时间：</strong> <span class="text-muted">{{ visitTime }}</span></p>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-6">
                    <button @click="refreshVisitorInfo" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-arrow-repeat"></i> 刷新访问信息
                    </button>
                </div>
                <div class="col-md-6 text-end">
                    <button @click="recordCurrentVisit" class="btn btn-success btn-sm">
                        <i class="bi bi-save"></i> 记录本次访问
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 访问统计卡片 -->
    <div class="card visitor-stats">
        <div class="card-header">
            <i class="bi bi-bar-chart"></i> 访问统计
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <div class="text-center">
                        <h4 class="text-warning">{{ totalVisitors }}</h4>
                        <p class="mb-0">总访问次数</p>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="text-center">
                        <h4 class="text-success">{{ uniqueIps }}</h4>
                        <p class="mb-0">独立IP数</p>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="text-center">
                        <h4 class="text-info">{{ todayVisitors }}</h4>
                        <p class="mb-0">今日访问</p>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="text-center">
                        <h4 class="text-primary">{{ thisPageVisits }}</h4>
                        <p class="mb-0">本页访问</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 最近访问记录卡片 -->
    <div class="card visit-record-card">
        <div class="card-header">
            <i class="bi bi-clock-history"></i> 最近访问记录
        </div>
        <div class="card-body">
            <div class="recent-visits">
                <div v-for="(visit, index) in recentVisits" :key="index" 
                     :class="['visit-item', { 'new': visit.isNew }]">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ visit.ip }}</strong>
                            <small class="text-muted ms-2">{{ visit.time }}</small>
                        </div>
                        <div>
                            <span class="badge bg-secondary">{{ visit.count }}次</span>
                        </div>
                    </div>
                    <div class="mt-1">
                        <small class="text-muted">{{ visit.userAgent }}</small>
                    </div>
                </div>
                <div v-if="recentVisits.length === 0" class="text-center py-3 text-muted">
                    <i class="bi bi-clock"></i> 暂无访问记录
                </div>
            </div>
        </div>
    </div>

    <!-- IP登记历史卡片 -->
    <div class="card">
        <div class="card-header">
            <i class="bi bi-list"></i> IP登记历史
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" v-model="searchName" class="form-control" placeholder="搜索IP地址...">
                        <button @click="filterList" class="btn btn-outline-secondary">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <button @click="refreshData" class="btn btn-primary">
                        <i class="bi bi-arrow-clockwise"></i> 刷新数据
                    </button>
                </div>
            </div>
            
            <div v-if="filtered_list && filtered_list.length > 0" class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead>
                    <tr>
                        <th scope="col">序号</th>
                        <th scope="col">姓名</th>
                        <th scope="col">IP地址</th>
                        <th scope="col">首次访问</th>
                        <th scope="col">最近访问</th>
                        <th scope="col">访问次数</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-for="(info, index) in filtered_list" :key="info.ip + info.name">
                        <th scope="row">{{ index + 1 }}</th>
                        <td>{{ info.name }}</td>
                        <td>
                            <span class="badge bg-success">{{ info.ip }}</span>
                        </td>
                        <td>{{ formatDate(info.first_visit) }}</td>
                        <td>{{ formatDate(info.last_visit) }}</td>
                        <td>
                            <span class="badge" :class="getVisitCountClass(info.visit_count)">
                                {{ info.visit_count }}
                            </span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div v-else class="text-center py-5">
                <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
                <p class="mt-3 text-muted">暂无IP登记记录</p>
            </div>
        </div>
    </div>

    <!-- Toast通知容器 -->
    <div class="toast-container">
        <div v-for="(toast, index) in toasts" 
             :key="toast.id" 
             :class="['toast-notification', toast.type, { closing: toast.closing }]">
            <i class="toast-icon bi" :class="{
                'bi-check-circle-fill': toast.type === 'success',
                'bi-exclamation-triangle-fill': toast.type === 'error',
                'bi-info-circle-fill': toast.type === 'info',
                'bi-exclamation-circle-fill': toast.type === 'warning'
            }"></i>
            <div class="toast-content">{{ toast.message }}</div>
            <button class="toast-close" @click="removeToast(toast.id)">&times;</button>
        </div>
    </div>
</div>

<script src="../css_js/own/lizi.js"></script>
<script>
    const { createApp } = Vue;

    createApp({
        mixins: [ToastMixin],
        data() {
            this.initPage();
            return {
                message: '登记个人IP',
                visitorIp: '',
                visitTime: '',
                searchName: '',
                list: [],
                filtered_list: [],
                loading: false,
                env: "",
                envMsg: "",
                envClass: "",
                totalVisitors: 0,
                uniqueIps: 0,
                todayVisitors: 0,
                thisPageVisits: 0,
                recentVisits: [],
                url: "http://172.16.29.23:90/php/controller",
                header: {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                },
                visitTimer: null,
                autoRecordInterval: 300000 // 5分钟自动记录一次
            }
        },

        mounted() {
            this.getVisitorIp();
            this.updateVisitTime();
            // 每分钟更新一次访问时间
            setInterval(this.updateVisitTime, 60000);
            
            // 开始自动记录定时器
            this.startAutoRecording();
            
            // 页面卸载时清理定时器
            window.addEventListener('beforeunload', () => {
                this.stopAutoRecording();
            });
        },

        beforeUnmount() {
            this.stopAutoRecording();
        },

        methods: {
            // 初始化页面，获取环境信息和数据
            async initPage() {
                this.loading = true;

                try {
                    const data = {
                        action: "registerIp",
                        params: {
                            recordVisit: true,
                            userAgent: navigator.userAgent
                        }
                    };

                    this.url = "http://172.16.29.23:90/php/controller";
                    let res = await axios.post(`${this.url}/search.php`, data, this.header);
                    
                    this.loading = false;
                    if (res.status === 200) {
                        this.list = res.data.allRecords || [];
                        this.filtered_list = [...this.list];
                        this.recentVisits = res.data.recent_visits || [];
                        this.thisPageVisits = res.data.this_page_visits || 0;
                        this.env = res.data.env;
                        this.setEnvMessage();
                        this.calculateStats();
                        
                        // 显示自动记录提示（如果是新访问）
                        if (res.data.new_visit_recorded) {
                            this.showAutoRecordIndicator();
                        }
                    }
                } catch (error) {
                    this.loading = false;
                    this.showError("初始化失败，无法获取数据");
                    console.error("初始化错误:", error);
                }
            },

            // 获取访问者IP地址
            async getVisitorIp() {
                try {
                    // 通过后端接口获取真实IP地址
                    const data = {
                        action: "getClientIp",
                        params: {}
                    };
                    
                    let res = await axios.post(`${this.url}/search.php`, data, this.header);
                    
                    if (res.status === 200 && res.data.success) {
                        this.visitorIp = res.data.ip;
                    } else {
                        // 备用方法：通过WebRTC获取本地IP
                        this.getLocalIP();
                    }
                } catch (error) {
                    console.log("无法通过后端获取IP，使用本地方法");
                    // 备用方法：通过WebRTC获取本地IP
                    this.getLocalIP();
                }
            },

            // 获取本地IP地址（备用方法）
            getLocalIP() {
                try {
                    const pc = new RTCPeerConnection({
                        iceServers: []
                    });
                    pc.createDataChannel('');
                    pc.onicecandidate = (e) => {
                        if (!e.candidate) return;
                        const ipRegex = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/;
                        const ipMatch = ipRegex.exec(e.candidate.candidate);
                        if (ipMatch) {
                            this.visitorIp = ipMatch[1];
                            pc.close();
                        }
                    };
                    pc.createOffer().then(offer => pc.setLocalDescription(offer));
                } catch (error) {
                    // 最后的备用方案：显示本地回环地址
                    this.visitorIp = '127.0.0.1';
                }
            },

            // 更新访问时间
            updateVisitTime() {
                const now = new Date();
                this.visitTime = now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            },

            // 设置环境信息显示
            setEnvMessage() {
                switch(this.env) {
                    case 'test':
                        this.envMsg = 'Test环境';
                        this.envClass = 'text-warning';
                        break;
                    case 'local':
                        this.envMsg = '开发环境';
                        this.envClass = 'text-info';
                        break;
                    case 'uat':
                        this.envMsg = 'UAT环境';
                        this.envClass = 'text-primary';
                        break;
                    default:
                        this.envMsg = '生产环境';
                        this.envClass = 'text-danger';
                }
            },

            // 计算统计数据
            calculateStats() {
                this.totalVisitors = this.list.reduce((sum, item) => sum + (item.visit_count || 1), 0);
                
                // 计算独立IP数
                const uniqueIpSet = new Set(this.list.map(item => item.ip));
                this.uniqueIps = uniqueIpSet.size;
                
                // 计算今日访问数
                const today = new Date().toDateString();
                this.todayVisitors = this.list.filter(item => {
                    const itemDate = new Date(item.last_visit).toDateString();
                    return itemDate === today;
                }).reduce((sum, item) => sum + (item.visit_count || 1), 0);
            },

            // 刷新访问者信息
            refreshVisitorInfo() {
                this.getVisitorIp();
                this.updateVisitTime();
                this.showSuccess("访问信息已刷新");
            },

            // 刷新数据
            async refreshData() {
                await this.initPage();
                this.showSuccess("数据已刷新");
            },

            // 过滤列表
            filterList() {
                if (!this.searchName.trim()) {
                    this.filtered_list = [...this.list];
                } else {
                    const searchTerm = this.searchName.toLowerCase();
                    this.filtered_list = this.list.filter(item => 
                        item.ip.toLowerCase().includes(searchTerm)
                    );
                }
            },

            // 格式化日期
            formatDate(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            },

            // 根据访问次数返回不同的样式类
            getVisitCountClass(count) {
                if (count >= 10) return 'bg-danger';
                if (count >= 5) return 'bg-warning';
                if (count >= 2) return 'bg-info';
                return 'bg-secondary';
            },

            // 手动记录本次访问
            async recordCurrentVisit() {
                this.loading = true;
                
                try {
                    const data = {
                        action: "registerIp",
                        params: {
                            recordVisit: true,
                            userAgent: navigator.userAgent,
                            manualRecord: true
                        }
                    };

                    let res = await axios.post(`${this.url}/update.php`, data, this.header);
                    
                    this.loading = false;
                    if (res.status === 200 && res.data.success) {
                        // 更新数据
                        this.list = res.data.allRecords || [];
                        this.filtered_list = [...this.list];
                        this.calculateStats();
                        
                        this.showSuccess(res.data.message || "访问记录已保存");
                    } else {
                        throw new Error(res.data.message || "服务器返回错误");
                    }
                } catch (error) {
                    this.loading = false;
                    this.showError("记录访问信息失败");
                    console.error("记录访问错误:", error);
                }
            },

            // 开始自动记录
            startAutoRecording() {
                // 立即记录一次
                this.recordVisitSilently();
                
                // 设置定时器，定期自动记录
                this.visitTimer = setInterval(() => {
                    this.recordVisitSilently();
                }, this.autoRecordInterval);
            },

            // 停止自动记录
            stopAutoRecording() {
                if (this.visitTimer) {
                    clearInterval(this.visitTimer);
                    this.visitTimer = null;
                }
            },

            // 静默记录访问（不显示loading）
            async recordVisitSilently() {
                try {
                    const data = {
                        action: "registerIp",
                        params: {
                            recordVisit: true,
                            userAgent: navigator.userAgent,
                            silent: true
                        }
                    };

                    let res = await axios.post(`${this.url}/search.php`, data, {
                        ...this.header,
                        timeout: 5000 // 5秒超时
                    });
                    
                    if (res.status === 200 && res.data.new_visit_recorded) {
                        // 更新统计数据
                        this.recentVisits = res.data.recent_visits || [];
                        this.thisPageVisits = res.data.this_page_visits || 0;
                        this.showAutoRecordIndicator();
                    }
                } catch (error) {
                    console.log("自动记录访问失败:", error.message);
                }
            },

            // 显示自动记录提示
            showAutoRecordIndicator() {
                const indicator = document.getElementById('autoRecordIndicator');
                if (indicator) {
                    indicator.classList.add('show');
                    setTimeout(() => {
                        indicator.classList.remove('show');
                    }, 3000);
                }
            }
        }
    }).mount('#app');
</script>
</body>
</html>