<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>PA sku预计留样标识查询或新增</title>
    <link href="../css_js/bootstrap-5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="../css_js/script/jquery-3.7.0.min.js"></script>
    <script src="../css_js/bootstrap-5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.staticfile.org/axios/0.18.0/axios.min.js"></script>
    <script src="../css_js/script/qs.min.js"></script>
    <!--粒子特效-->
    <link rel="stylesheet" href="../css_js/own/lizi.css">
</head>
<body>
<div class="container text-center" id="app">
    <div style="margin-top: 20px" class="row">
        <div class="col-5"><h3 style="color: yellow">{{message}} <br>查询或新增<br> <span style="color: red">当前环境：{{envMsg}}</span></h3></div>
        <div class="col-7">
            <div class="mb-3">
                <textarea v-model="skuIdString" class="form-control" placeholder="skuId,多个请换行" rows="5"/></textarea>
            </div>
            <div class="row">
                <div class="col-3">
                    <button class="btn btn-primary" @click="search">查询预计留样</button>
                </div>
            </div>
        </div>

        <div class="col-8" style="margin-top: 20px">
            <table class="table table-dark table-striped align-middle" v-if="list && list.length > 0">
                <thead>
                <tr>
                    <th scope="col">id</th>
                    <th scope="col">sku<br>是否预计留样<br>留样类型</th>
                    <th scope="col">状态</th>
                    <th scope="col">创建人<br>创建日期</th>
                    <th scope="col">更新日期</th>
                </tr>
                </thead>
                <tbody>
                <tr v-for="info in list" :key="info.id">
                    <td>{{info.id}}</td>
                    <td>
                        <template v-if="info.isSample == '未留样'">
                            <b style="color: red">{{info.skuId}}</b>
                        </template>
                        <template v-if="info.isSample == '有留样'">
                            {{info.skuId}}<br>
                            {{info.category}}
                        </template>
                        <br>
                        <template v-if="info.isSample == '未留样'">
                            <b style="color: red">{{info.isSample}}</b>
                        </template>
                        <template v-if="info.isSample == '有留样'">
                            {{info.isSample}}
                        </template>
                    </td>
                    <td>
                        {{info.state}}
                    </td>
                    <td>{{info.createBy}}<br>{{info.createTime}}</td>
                    <td>
                        {{info.updateTime}}
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="col-4">
            <div class="mb-3">
                <h5 style="color:white;">处理打留样标识的sku</h5>
            </div>
            <div class="mb-3">
                <textarea v-model="addSkuIdString" class="form-control" placeholder="skuId,多个请换行" rows="5"/></textarea>
            </div>
            <div class="mb-3">
                <select class="form-select" aria-label="是否只更新日期" v-model="status" @change="changeStatus">
                    <option value="">请选择</option>
                    <option value="1">只改更新日期</option>
                </select>
            </div>
            <div class="row">
                <div class="col-3">
                    <button class="btn btn-primary" @click="update">确定</button>
                </div>
            </div>

            <div class="row">
                <h5 style="color: red">{{loading}}</h5>
                <h4 style="color: red">{{errorMsg}}</h4>
            </div>

        </div>

    </div>

</div>

</body>
</html>
<script src="../css_js/own/lizi.js"></script>


<script>

    const {createApp, ref,onMounted} = Vue


    createApp({

        data() {
            this.initPage();
            return {
                message: 'PA sku预计留样标识',
                skuIdString: '',
                addSkuIdString: '',
                status: '',
                onlyUpdateTime:false,
                errorMsg: '',
                successMsg: '',
                list: [],
                loading: '',
                env:"",
                envMsg:"",
                url:"http://172.16.29.23:90/php/controller",
                header: {
                    headers: {
                        'Content-Type': 'application/json',
                        // 其他自定义头
                    }
                }
            }
        },

        methods: {
            async initPage(){
                const data = {
                    action: "paSampleSku",
                    params: {},
                };
                this.header = {
                    headers: {
                        'Content-Type': 'application/json',
                        // 其他自定义头
                    }
                };
                this.url = "http://172.16.29.23:90/php/controller";
                let res = await axios.post(`${this.url}/search.php`, data,this.header).catch(function (error) {
                    this.errorMsg = "网络错误";
                });
                this.loading = "";
                if (res.status === 200) {
                    this.env = res.data.env;
                    this.envMsg = this.env == 'test' ? 'Test环境' :  (this.env == 'local' ?  '开发环境' :  (this.env == 'uat' ?  'UAT环境' : '生产环境'));
                }

            },
            async update() {
                this.loading = "............请等待，正在处理数据中..........";
                this.errorMsg = "";

                if (!this.addSkuIdString) {
                    this.errorMsg = "请输入sku!!!!!!";
                    this.loading = "............报错..........";
                    return;
                }
                //做转义
                let addskuIdList = this.addSkuIdString.split("\n");
                addskuIdList =  [...new Set(addskuIdList.filter(item => item))];
                // if (addskuIdList.length > 500){
                //     this.errorMsg = "sku添加过多，请不要超过500个";
                //     this.loading = "............报错..........";
                //     return;
                // }
                const data = {
                    action: "paSampleSku",
                    params: {
                        addskuIdList: addskuIdList,
                        onlyUpdateTime: this.onlyUpdateTime
                    },
                };
                let res = await axios.post(`${this.url}/update.php`, data,this.header).catch(function (error) {
                    this.errorMsg = "网络错误";
                });
                console.log(res)
                if (res.status === 200 && res.data === true) {
                    this.loading = "............可以刷新查看了..........";
                } else {
                    this.loading = "............报错..........";
                }

                this.loading = "";
            },

            async search() {
                this.loading = "............请等待，正在处理数据中..........";
                this.errorMsg = "";
                this.list = [];
                if (!this.skuIdString){
                    this.errorMsg = "请输入sku";
                    this.loading = "............报错..........";
                    return;
                }
                //做转义
                let skuIdList = this.skuIdString.split("\n");
                skuIdList =  [...new Set(skuIdList.filter(item => item))];
                if (skuIdList.length > 500){
                    this.errorMsg = "sku查询过多，请不要超过500个";
                    this.loading = "............报错..........";
                    return;
                }

                const data = {
                    action: "paSampleSku",
                    params: {
                        skuIdList: skuIdList,
                    },
                };
                let res = await axios.post(`${this.url}/search.php`, data,this.header).catch(function (error) {
                    this.errorMsg = "网络错误";
                });
                console.log(res)
                this.loading = "";
                if (res.status === 200) {
                    let returnlist = res.data.data;
                    let skuMap = {};
                    for (let item of returnlist){
                        if (!skuMap.hasOwnProperty(item.skuId)){
                            skuMap[item.skuId] = [];
                        }
                        skuMap[item.skuId].push(item);
                    }
                    for (let sku of skuIdList){
                        if (skuMap.hasOwnProperty(sku)){
                            for(let i of skuMap[sku]){
                                i['isSample'] = "有留样";
                                this.list.push(i);
                            }
                        }else {
                            this.list.push({
                                id:null,
                                skuId:sku,
                                category:"",
                                state:"",
                                isSample:"未留样",
                                createBy:"",
                                createTime:"",
                            });
                        }

                    }

                }

            },
            changeStatus(){
                if (this.status == '1'){
                    this.onlyUpdateTime = true;
                }else {
                    this.onlyUpdateTime = false;
                }
            }
        },


    }).mount('#app')


</script>