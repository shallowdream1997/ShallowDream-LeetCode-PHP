<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PA 上传文件到OSS</title>
    <link href="../css_js/bootstrap-5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="../css_js/script/jquery-3.7.0.min.js"></script>
    <script src="../css_js/bootstrap-5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.staticfile.org/axios/0.18.0/axios.min.js"></script>
    <script src="../css_js/script/qs.min.js"></script>
    <!--粒子特效-->
    <link rel="stylesheet" href="../css_js/own/lizi.css">
</head>
<body>
<div class="container text-center" id="app">
    <div style="margin-top: 20px" class="row">
        <div class="col-5"><h3 style="color: yellow">{{message}} <br>查询或新增<br> <span style="color: red">当前环境：{{env == 'test' ? '测试环境' :  (env == 'local' ?  '开发环境' : '生产环境')}}</span></h3></div>
        <div class="col-7">
            <div class="mb-3">
                <input class="btn btn-primary" type="file" @change="handleFileUpload" />
            </div>

            <div class="mb-3">
                <button class="btn btn-primary" style="margin-left: 10px" @click="uploadFile">导入文件</button>
            </div>

            <div class="mb-3" v-if="this.fileName">
                <button class="btn btn-danger" @click="update">确认上传到OSS</button>
            </div>

        </div>
        <div class="col-2"></div>
        <div class="col-10" style="margin-top: 20px;color: white" v-if="this.ossLink">
            点击下载oss文件：<a @click="downloadOssLink(this.ossLink)" class="coll-btn">{{this.ossLink}}</a>
        </div>

        <div class="col-12" style="margin-top: 20px">
            <div class="row">
                <h5 style="color: red">{{loading}}</h5>
                <h4 style="color: red">{{errorMsg}}</h4>
                <h4 style="color: green">{{successMsg}}</h4>
            </div>
        </div>
    </div>

</div>

</body>
</html>
<script src="../css_js/own/lizi.js"></script>


<script>

    const {createApp, ref,onMounted} = Vue


    createApp({

        data() {
            console.log(getDomainAndPort());
            this.initPage();
            return {
                message: '上传文件到OSS',
                errorMsg: '',
                successMsg: '',
                selectedFile: null,
                fileName:"",
                fullPath:"",
                ossLink:"",
                loading: '',
                env:"",
                url:"http://172.16.29.23:90/php/controller",
                header: {
                    headers: {
                        'Content-Type': 'application/json',
                        // 其他自定义头
                    }
                }
            }
        },

        methods: {
            async initPage(){
                const data = {
                    action: "uploadOss",
                    params: {},
                };
                this.header = {
                    headers: {
                        'Content-Type': 'application/json',
                        // 其他自定义头
                    }
                };
                this.url = "http://172.16.29.23:90/php/controller";
                let res = await axios.post(`${this.url}/search.php`, data,this.header).catch(function (error) {
                    this.errorMsg = "网络错误";
                });
                this.loading = "";
                if (res.status === 200) {
                    this.env = res.data.env;
                }

            },
            handleFileUpload(event) {
                this.selectedFile = event.target.files[0];
            },
            async uploadFile() {
                if (this.selectedFile) {
                    const formData = new FormData();
                    formData.append('fileToUploadOss', this.selectedFile);

                    try {
                        const response = await axios.post(`${this.url}/upload.php`, formData, {
                            headers: {
                                'Content-Type': 'multipart/form-data'
                            }
                        });
                        this.successMsg = "";
                        this.errorMsg = "";
                        this.fullPath = "";
                        this.fileName = "";
                        if (response && response.data.code == 200){
                            this.successMsg = response.data.message + "，文件名称：" + response.data.fileName;
                            this.fileName = response.data.fileName;
                            this.fullPath = response.data.fullPath;
                        }else {
                            this.errorMsg = response.data;
                        }

                    } catch (error) {
                        this.errorMsg = '加载文件失败';
                    }
                } else {
                    this.errorMsg = '请选择一个文件';
                }
            },
            async update(){
                this.loading = "............请等待，正在处理数据中..........";
                this.errorMsg = "";

                if (!this.fileName) {
                    this.errorMsg = "请先确保上文文件内容是否正确";
                    this.loading = "............报错..........";
                    return;
                }

                const data = {
                    action: "uploadOss",
                    params: {
                        fileName: this.fileName,
                        fullPath: this.fullPath
                    },
                };
                let res = await axios.post(`${this.url}/update.php`, data,this.header).catch(function (error) {
                    this.errorMsg = "网络错误";
                });
                console.log(res)
                this.successMsg = "";
                this.errorMsg = "";
                if (res && res.data && res.data.uploadSuccess){
                    this.ossLink = res.data.link;
                    this.successMsg = res.data.messages;
                }else {
                    this.errorMsg = res.data.messages;
                }

                this.loading = "结束";
            },
            async downloadOssLink(link){
                window.open(link);
            }
        },


    }).mount('#app')


</script>